"use strict";
require.config(requireConfig),require(["jquery","tmpl","i18n","bootstrap","common","star"],function(e,t,i,n,r,a){function o(t,i){e("#orderId").html(t),r.dao.getOrderDetail({orderId:t},function(t){y=[],null==x&&(x=1!=t.cmtTpe),e("#orderDate").html(r.util.formatOrderDateTime(t.crTime));var n=r.util.getCurrencySymbol(t.correncyCode);n||(n=r.util.getCurrencySymbol(r.util.getLocalCurrency()));var a=r.util.getAdvSource().u,o=r.util.encodeMenuType(r.util.getUvid());a||(a=r.util.getQueryString("u"));var l="";l=a?"?u="+a+"&uvid="+o:"?uvid="+o;for(var m=0;m<t.spCart.length;m++){var s=t.spCart[m];s.displayImg=r.util.picUrl+s.displayImg,s.productPrice=r.util.formatProductPrice(s.productPrice,n);var c=r.util.formatProductName(s.productName)+"-d-"+r.util.encodeMenuType(s.productId)+".html"+l;s.href=c,x?L?s.zjcmId&&"0"!=s.zjcmId||L!=s.productColorId||(s.serverImageList=[],s.imageList=[],y.push(s)):s.zjcmId&&"0"!=s.zjcmId||(s.serverImageList=[],s.imageList=[],y.push(s)):s.cmId&&"0"!=s.cmId||(s.serverImageList=[],s.imageList=[],y.push(s))}f(),i&&0==y.length&&(e("#submit_comment_success_mask").addClass("hide"),""===document.referrer?window.location.href="/":window.history.go(-1))})}function l(t){for(var i=0;i<t.length;i++)x?e("#comment_star_input_"+i).parent().parent().addClass("hide"):e("#comment_star_input_"+i).rating({step:1,size:"xs",showClear:!1,min:0,max:5,showCaption:!1}).rating("update",5),e("#cart_list #comment_content_input_"+i).attr("placeholder",e.i18n.map.CommentContentPlaceHolder),e("#cart_list #comment_video_input_"+i).attr("placeholder",e.i18n.map.CommentVideoPlaceHolder),e("#upload_input_"+i).change(function(){var i=e(this)[0].id;R=Number(i.substring(i.lastIndexOf("_")+1)),console.log("updateInputIndex = "+R);var n=null,r=document.getElementById("upload_input_"+R);if(r.files)n=r.files[0],s(n);else{r.select(),r.blur();var a=document.selection.createRange().text;console.log("filePath = "+a),t[R].imageList.push(a),v()}}),I(i,500),e("#comment_content_input_"+i).bind("input propertychange",function(){var t=e(this)[0].id;I(Number(t.substring(t.lastIndexOf("_")+1)),500-e(this).val().length)})}function m(e,t){h(g(e,t))}function s(t){t.size>b?(alert(e.i18n.map.CommentMaxFileSize),e("#upload_input_"+R).val("")):t.size>w?(c(t),u(t,m)):(c(t),d(t,m))}function c(e){var t=window.URL||window.webkitURL,i=t.createObjectURL(e);y[R].imageList.push(i),v()}function d(e,t){var i=new FileReader;i.onload=function(){var n=i.result;t(n,e.name)},i.readAsDataURL(e)}function u(t,i){if("undefined"==typeof FileReader)console.log("The current browser kernel does not support base64 image compression"),d(t,i);else try{var n=new FileReader;n.onload=function(n){var r=e("<img/>");r.load(function(){var e=this.height/(this.width/300),n=document.createElement("canvas"),r=n.getContext("2d"),a=0,o=0,l=0,m=0,s="";n.width=300,n.height=e,r.clearRect(0,0,300,e),this.width>300?(a=Math.round(300),o=e,l=Math.round((a-300)/2)):(o=Math.round(e),a=300,m=Math.round((o-e)/2)),r.drawImage(this,l,m,a,o);var s=n.toDataURL("image/jpeg");i(s,t.name)}),r.attr("src",n.target.result)},n.readAsDataURL(t)}catch(e){console.log("Compression failed!"),d(t,i)}}function g(e,t){for(var i=e.split(","),n=i[0].match(/:(.*?);/)[1],r=atob(i[1]),a=r.length,o=new Uint8Array(a);a--;)o[a]=r.charCodeAt(a);return new File([o],t,{type:n})}function p(t){y[R].serverImageList.push(t),e("#comment_image_list_"+R+" .comment-image-item:last-child").find(".icon-spinner").addClass("hide")}function h(t){console.log("updateImage");var i=new FormData;i.append("file",t),r.dao.uploadCommentImg(i,function(e){p(e)},null,function(){e("#upload_input_"+R).val("")})}function _(e){e&&0!=e.length&&r.dao.delCommentImg({inputParams:JSON.stringify(e)},function(){if(1==e.length){for(var t=e[0],i=-1,n=0;n<y[R].serverImageList.length;n++)if(t==y[R].serverImageList[n]){i=n;break}-1!==i&&(y[R].serverImageList.splice(i,1),y[R].imageList.splice(i,1),v(!0))}else for(var n=0;n<y.length;n++)y[n].serverImageList=[],y[n].imageList=[]})}function f(){e("#cart_list").html(e("#cartTempl").tmpl(y)),e("#cart_list #color_title").html(e.i18n.map.ColorTitle),e("#cart_list #rating_label").html(e.i18n.map.CommentRatingLabel),e("#cart_list #content_label").html(e.i18n.map.CommentContentLabel),e("#cart_list #video_label").html(e.i18n.map.CommentVideoLabel),l(y)}function v(t){var i=y[R].imageList;i&&i.length>0?(e("#comment_image_list_"+R).html(e("#commentImageTempl").tmpl(i)),t||e("#comment_image_list_"+R+" .comment-image-item:last-child").find(".icon-spinner").removeClass("hide"),e("#comment_image_list_"+R).removeClass("hide"),e("#comment_image_list_"+R+" .icon-close").each(function(){e(this).click(function(){var t=e(this).parent().parent()[0].id;R=Number(t.substring(t.lastIndexOf("_")+1));for(var i=e(this).parent().find("img")[0].src,n=-1,r=0;r<y[R].imageList.length;r++)if(i==y[R].imageList[r]){n=r;break}if(-1!==n){_([y[R].serverImageList[n]])}})}),3==i.length&&e("#update_layout_"+R).addClass("hide")):e("#comment_image_list_"+R).addClass("hide")}function I(t,i){var n=e.i18n.map.CommentContentHint;n=n.replace("%",i);var r=n.substring(0,n.indexOf(i)),a=n.substring(n.indexOf(i)+ +(""+i).length,n.length);e("#word_number_"+t).html(r+"<span class='red'>"+i+"</span>"+a)}r.initLoginStatus();var C=r.util.getQueryString("id"),L=r.util.getQueryString("productColorId"),b=4194304,w=102400,y=[],R=0,x=null;!function(){window.onbeforeunload=function(e){for(var t=[],i=0;i<y.length;i++){var n=y[i].serverImageList;n&&n.length>0&&(t=t.concat(n))}t.length>0&&_(t)},e("#addCommentBtn").click(function(){var t=r.util.getUserId();if(!t)return void(window.location.href="../../../login.html");for(var i=[],n=[],a=0;a<y.length;a++){var o=y[a],l=e("#comment_star_input_"+a).val(),m=e("#comment_content_input_"+a).val();if(x&&(l="5"),l&&m){var s={shareimgs:y[a].serverImageList,sharevideo:"",videourl:e("#comment_video_input_"+a).val(),orderId:C,productId:o.productId,productColorId:o.productColorId,cmId:o.cmId&&"0"!==o.cmId?o.cmId:null,attrDes:o.attrDes,tEval:x?null:l,content:m,userId:t};i.push(s)}else y[a].serverImageList&&y[a].serverImageList.length>0&&(n=n.concat(y[a].serverImageList))}if(0==i.length)return void alert("请至少填写一个商品的评分和评价内容");var c=i;r.dao.submitComment({inputParams:JSON.stringify(c)},function(){e("#submit_comment_success_mask").removeClass("hide"),_(n)})}),e("#confirmBtn").click(function(){e("#submit_comment_success_mask").addClass("hide"),o(C,!0)})}(),o(C)});